const lang = {
	af: "アフリカーンス語",
	sq: "アルバニア語",
	am: "アムハラ語",
	ar: "アラブソン語",
	hy: "アルメニア語",
	as: "アッサム語",
	ay: "マイマラ語",
	az: "アゼルバイジャン語",
	bm: "バンバラ語",
	be: "ベラルーシ語",
	bn: "ベンガル語",
	bho: "ボージュプリー語",
	bs: "ボスニア語",
	bg: "ブルガリア語",
	ca: "カタロニア語",
	ceb: "セブ語",
	"zh-CN": "中国語（簡体）",
	"zh-TW": "中国語（繁体）",
	co: "コルシカ語",
	hr: "クロアチア語",
	cs: "チェコ語",
	da: "デンマーク語",
	dv: "ディベヒ語",
	doi: "ドグリ語",
	nl: "オランダ語",
	en: "英語",
	eo: "エスペラント語",
	et: "エストニア語",
	ee: "エウェ語",
	fil: "フィリピン語（タガログ語）",
	fi: "フィンランド語",
	fr: "フランス語",
	fy: "フリジア語",
	gl: "ガリシア語",
	ka: "グルジア語",
	de: "ドイツ語",
	el: "ギリシャ語",
	gn: "グアラニ語",
	gu: "グジャラート語",
	ht: "クレオール語（ハイチ）",
	ha: "ハウサ語",
	haw: "ハワイ語",
	he: "ヘブライ語",
	iw: "ヘブライ語",
	hi: "ヒンディー語",
	hmn: "モン語",
	hu: "ハンガリー語",
	is: "アイスランド語",
	ig: "イボ語",
	ilo: "イロカノ語",
	id: "インドネシア語",
	ga: "アイルランド語",
	it: "イタリア語",
	ja: "日本語",
	jv: "ジャワ語",
	jw: "ジャワ語",
	kn: "カンナダ文字",
	kk: "カザフ語",
	km: "クメール語",
	rw: "キニヤルワンダ語",
	gom: "コンカニ語",
	ko: "韓国語",
	kri: "クリオ語",
	ku: "クルド語",
	ckb: "クルド語（ソラニ語）",
	ky: "キルギス語",
	lo: "ラオ語",
	la: "ラテン語",
	lv: "ラトビア語",
	ln: "リンガラ語",
	lt: "リトアニア語",
	lg: "ルガンダ語",
	lb: "ルクセンブルク語",
	mk: "マケドニア語",
	mai: "マイティリー語",
	mg: "マラガシ語",
	ms: "マレー語",
	ml: "マラヤーラム文字",
	mt: "マルタ語",
	mi: "マオリ語",
	mr: "マラーティー語",
	"mni-Mtei": "メイテイ語（マニプリ語）",
	lus: "ミゾ語",
	mn: "モンゴル語",
	my: "ミャンマー語（ビルマ語）",
	ne: "ネパール語",
	no: "ノルウェー語",
	ny: "ニャンジャ語（チェワ語）",
	or: "オリヤ語",
	om: "オロモ語",
	ps: "パシュト語",
	fa: "ペルシャ語",
	pl: "ポーランド語",
	pt: "ポルトガル語（ポルトガル、ブラジル）",
	pa: "パンジャブ語",
	qu: "ケチュア語",
	ro: "ルーマニア語",
	ru: "ロシア語",
	sm: "サモア語",
	sa: "サンスクリット語",
	gd: "スコットランド ゲール語",
	nso: "セペディ語",
	sr: "セルビア語",
	st: "セソト語",
	sn: "ショナ語",
	sd: "シンド語",
	si: "シンハラ語",
	sk: "スロバキア語",
	sl: "スロベニア語",
	so: "ソマリ語",
	es: "スペイン語",
	su: "スンダ語",
	sw: "スワヒリ語",
	sv: "スウェーデン語",
	tl: "タガログ語（フィリピン語）",
	tg: "タジク語",
	ta: "タミル語",
	tt: "タタール語",
	te: "テルグ語",
	th: "タイ語",
	ti: "ティグリニャ語",
	ts: "ツォンガ語",
	tr: "トルコ語",
	tk: "トルクメン語",
	ak: "トウィ語（アカン語）",
	uk: "ウクライナ語",
	ur: "ウルドゥー語",
	ug: "ウイグル語",
	uz: "ウズベク語",
	vi: "ベトナム語",
	cy: "ウェールズ語",
	xh: "コーサ語",
	yi: "イディッシュ語",
	yo: "ヨルバ語",
	zu: "ズールー語",
};

// prettier-ignore
const pref_lang = [
    "ja",
    "en",
    "ig",
    "gd",
];

const now_lang = ["ja", "en", "ja"];

const sampleTexts = [
	{
		name: "おにぎり",
		text: `おにぎり`,
	},
	{
		name: "吾輩は猫である",
		text: `吾輩は猫である。名前はまだ無い。どこで生れたかとんと見当がつかぬ。何でも薄暗いじめじめした所でニヤーニヤー泣いてゐた事だけは記憶してゐる。吾輩はここで始めて人間といふものを見た。しかもあとで聞くとそれは書生といふ人間中で一番獰悪な種族であつたさうだ。この書生といふのは時々我々を捕へて煮て食ふといふ話である。しかしその当時は何といふ考へもなかつたから別段恐しいとも思はなかつた。`,
	},
];

jasc.on("DOMContentLoaded", function () {
	let html = `<optgroup label="よく使用する言語">`;

	for (let i = 0; i < pref_lang.length; i++) {
		const lg = pref_lang[i];
		html += `<option value="${lg}">[${lg}]${lang[lg]}</option>`;
	}
	html += `</optgroup>
    <optgroup label="すべての言語">`;
	for (let key in lang) {
		html += `<option value="${key}">[${key}]${lang[key]}</option>`;
	}

	html += `</optgroup>`;
	jasc.acq("#trans-lang").innerHTML = html;

	const sampleBtns = jasc.acq("#sample-btns");

	for (let i = 0; i < sampleTexts.length; i++) {
		const sample = sampleTexts[i];
		const inp = document.createElement("input");
		inp.type = "button";
		inp.value = sample.name;
		sampleBtns.appendChild(inp);
		inp.addEventListener("click", function () {
			baseText.value = sample.text;
		});
	}

	const urlLang = location.search.replace(/^\?/, "").split("&");
	let pushFlag = false;
	for (let i = 0, li = urlLang.length; i < li; i++) {
		if (lang[urlLang[i]]) {
			if (!pushFlag) {
				now_lang.splice(0, now_lang.length);
				pushFlag = true;
			}
			now_lang.push(urlLang[i]);
		}
	}

	jasc.acq("#lang-form [type=button]")[0].addEventListener("click", function () {
		now_lang.push(jasc.acq("#trans-lang").value);
		updateTable();
	});

	updateTable();

	jasc.acq("#doTranslate").addEventListener("click", function () {
		jasc.acq("#doTranslate").disabled = true;
		let cards = jasc.acq(`.card:has(.transRoute)`);
		for (let i = 0; i < cards.length; i++) {
			cards[i].classList.add("transing");
		}
		nextTranslate();
	});
});

function updateTable() {
	const tbodyElm = jasc.acq("#langs");
	let html = "";

	for (let i = 0; i < now_lang.length; i++) {
		const lg = now_lang[i];
		html += `<tr>
            <td>${i + 1}</td>
            <td class="ud">
                <div>
                    <a href="javascript:moveLang(${i}, 'up')">▲</a>
                    <a href="javascript:moveLang(${i}, 'down')">▼</a>
                </div>
            </td>
            <td class="lang-name">[${lg}]${lang[lg]}</td>
            <td class="del">
                <div>
                    <input type="button" value="削除" onclick="removeLang(${i})">
                </div>
            </td>
        </tr>`;
	}

	tbodyElm.innerHTML = html;
}

function moveLang(from, type) {
	switch (type) {
		case "up":
			now_lang.splice(from - 1, 2, now_lang[from], now_lang[from - 1]);
			break;
		case "down":
			now_lang.splice(from, 2, now_lang[from + 1], now_lang[from]);
			break;
	}
	updateTable();
}

function removeLang(from) {
	now_lang.splice(from, 1);
	updateTable();
}

function nextTranslate(i = 0) {
	if (i + 1 >= now_lang.length) {
		endTrans();
		return;
	}
	if (now_lang[i] == now_lang[i + 1]) {
		now_lang.splice(i + 1, 1);
		updateTable();
		nextTranslate(i);
		return;
	}
	let str;
	if (i == 0) {
		str = jasc.acq("#baseText").value;
	} else {
		str = jasc.acq(`#transCard${i} .transRoute`)[0].value;
	}
	const par = jasc.acq("#translates");
	googleTranslate(str, now_lang[i + 1], now_lang[i]).then(setPlace);
	return;
	function setPlace(s) {
		if (now_lang[i] == now_lang[i + 1]) {
			endTrans();
			return;
		}
		let em;
		[s, em] = s;
		const baseElm = getTextarea(`transCard${i + 1}`, par);
		jasc.acq(".transRoute", baseElm)[0].value = s;
		let lanStr = `${now_lang[i]} → ${now_lang[i + 1]}`;
		let isError = false;
		if (em != "null") {
			lanStr += ` (${em})`;
			isError = true;
		}
		jasc.acq(".langData", baseElm)[0].textContent = lanStr;

		if (isError) {
			if (now_lang[i + 1] == "en") {
				endTrans();
				return;
			}
			// エラーの場合、"en"を追加して回避する
			now_lang.splice(i + 1, 0, "en");
			updateTable();
			googleTranslate(str, now_lang[i + 1], now_lang[i]).then(setPlace);
		} else {
			baseElm.classList.remove("transing");
			nextTranslate(i + 1);
		}
	}
}

function endTrans() {
	jasc.acq("#doTranslate").disabled = false;
	let p = now_lang.join("&");
	jasc.historyPush(`${location.protocol}//${location.host}${location.pathname}?${p}`);
}

function getTextarea(id, par = document.body) {
	let elm = jasc.acq(`#${id}`);

	if (!elm) {
		const template = jasc.acq("#transCard-template");
		const data = template.content.cloneNode(true);
		par.appendChild(data);
		elm = jasc.acq(".card:not([id])", par)[0];
		elm.id = id;
	}

	return elm;
}

function googleTranslate(str, target = "en", source = "") {
	const url = "https://script.google.com/macros/s/AKfycbxg7AQ1ywGUhaN2kOn8KjU1vSgJk3FvAx1uuX08GSiAV7r7oGtoPq2gzfWidgyye9y_rg/exec";

	return new Promise((resolve, reject) => {
		let p = fetch(url, {
			method: "POST",
			body: JSON.stringify({
				events: {
					type: "translate",
					content: str,
					source: source,
					target: target,
				},
			}),
		});
		p.then((res) => {
			if (res.status == 200) {
				console.log("送信成功です");
				res.json()
					.then((res) => {
						resolve([decodeURIComponent(res.data.content), decodeURIComponent(res.data.errMes)]);
					})
					.catch((err) => {
						console.error(err);
						reject(err);
					});
			} else {
				console.warn("送信失敗です: " + res.status);
				reject(res);
			}
			return;
		}).catch((err) => {
			console.error(err);
			reject(err);
		});
	});
}
